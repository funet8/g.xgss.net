(window.webpackJsonp=window.webpackJsonp||[]).push([[210],{790:function(s,a,e){"use strict";e.r(a);var t=e(17),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"nginx从入门到放弃06-nginx的n种特别实用示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx从入门到放弃06-nginx的n种特别实用示例"}},[s._v("#")]),s._v(" Nginx从入门到放弃06-Nginx的N种特别实用示例")]),s._v(" "),e("p",[s._v("从前面的几篇教程里面我们知道了nginx的安装和调优、负载均衡、反向代理等，这篇文档我们来介绍Nginx的N种特别实用示例")]),s._v(" "),e("p",[s._v("笔者把自己总结的文档分为几遍，合集在 https://g.xgss.net/nginx/")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://imgoss.xgss.net/picgo/nginx06.jpg?aliyun",alt:"nginx06"}})]),s._v(" "),e("h1",{attrs:{id:"一、location"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、location"}},[s._v("#")]),s._v(" 一、location")]),s._v(" "),e("p",[s._v("location块负责匹配url，root指令负责将匹配到的url与服务器中某个具体目录对应起来。")]),s._v(" "),e("p",[s._v("语法规则：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location [=|~|~*|^~] /uri/ { … }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("location优先级")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("(location =) > (location 完整路径 ) >(location ^~ 路径) >(location ~*, ~ 正则) >(location 部分起始路径) 正则表达式根据配置文件中的前后顺序影响匹配, 前面的优先匹配. 其它则根据匹配长度来优先匹配.\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"精确匹配-开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#精确匹配-开头"}},[s._v("#")]),s._v(" 精确匹配(=开头)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location = / {\t\t\n   #规则A\n}\nlocation = /login {\n   #规则B\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"开头某个常规字符串"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开头某个常规字符串"}},[s._v("#")]),s._v(" ^~ 开头某个常规字符串")]),s._v(" "),e("p",[s._v("表示uri以某个常规字符串开头，理解为匹配url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ^~ /static/ {\t\n   #规则C\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"区分大小写-开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#区分大小写-开头"}},[s._v("#")]),s._v(" 区分大小写(~ 开头)")]),s._v(" "),e("p",[s._v("表示区分大小写的正则匹配")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ \\.(gif|jpg|png|js|css)$ {\n   #规则D\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"不区分大小写-开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#不区分大小写-开头"}},[s._v("#")]),s._v(" 不区分大小写(~*开头)")]),s._v(" "),e("p",[s._v("表示不区分大小写的正则匹配")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~* \\.png$ {\n   #规则E\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"和-表示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#和-表示"}},[s._v("#")]),s._v(" !~和!~*表示")]),s._v(" "),e("p",[s._v("分别为区分大小写不匹配及不区分大小写不匹配 的正则")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location !~ \\.xhtml$ {\n   #规则F\n}\nlocation !~* \\.xhtml$ {\n   #规则G\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"通用匹配-开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通用匹配-开头"}},[s._v("#")]),s._v(" 通用匹配(/ 开头)")]),s._v(" "),e("p",[s._v("任何请求都会匹配到。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location / {\n   #规则H\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h1",{attrs:{id:"二、nginx实用实例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、nginx实用实例"}},[s._v("#")]),s._v(" 二、Nginx实用实例")]),s._v(" "),e("h3",{attrs:{id:"_1-设置缓存时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-设置缓存时间"}},[s._v("#")]),s._v(" 1.设置缓存时间")]),s._v(" "),e("p",[s._v("控制图片、HTML等静态文件过期时间为30天，当然这个时间可以设置的更长。具体视情况而定")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ .*\\.(htm|html|css|js|jpg|jpeg|gif|png|ico|bmp|gz|xml|zip|rar|swf|txt|xls|xlsx|flv|mid|doc|ppt|pdf|mp3|wma|exe)?$ {\n                root /data/pic/;\n                expires     30d;\n                access_log /dev/null;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("expires设置缓存时间")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("expires [time|epoch|max|off]\nexpires epoch 指定“Expires”的值为 1 January, 1970, 00:00:01 GMT。\nexpires max 指定“Expires”的值为 31 December 2037 23:59:59 GMT，“Cache-Control”的值为10年。\nexpires -1 指定“Expires”的值为 服务器当前时间 -1s,即永远过期\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_2-http跳转到https"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-http跳转到https"}},[s._v("#")]),s._v(" 2.HTTP跳转到HTTPS")]),s._v(" "),e("p",[s._v("如下http80端口项目301跳转到https")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n  listen       80;\n  server_name  www.test.com;\n  return 301   https://$host$request_uri;\n}\n\nif ($host = 'test.com') {\n        rewrite ^/(.*)$ https://www.test.com/$1 permanent;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("https配置，需要获取域名证书。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n        listen       443;\n        server_name  www.test.com;\n        root /data/wwwroot/www.test.com/;\n        access_log /data/wwwroot/log/ssl_www.test.com-access.log;\n        error_log /dev/null;\n\n\t\tssl on;\n\t\tssl_certificate /data/wwwroot/cert/www.test.com.pem;\n\t\tssl_certificate_key /data/wwwroot/cert/www.test.com.key;\n\t\tssl_session_timeout 5m;\n\t\tssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n\t\tssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n\t\tssl_prefer_server_ciphers on;\n\n        location / {\n                index  index.html index.htm index.php;\n        }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"_3-设置404页面"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-设置404页面"}},[s._v("#")]),s._v(" 3.设置404页面")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("error_page 404 = http://www.baidu.com/hot/jmb/?from=404_hlx&404_url=$scheme://$host$request_uri&404_from=$http_referer;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("解释：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("http://www.nginx01.com/1111?from=testpage\n如果是404则会跳转到：\nhttps://www.baidu.com/hot/jmb/?from=404_hlx&404_url=http://www.nginx01.com/1111?from=testpage&404_from=\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_4-配置php不缓存"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-配置php不缓存"}},[s._v("#")]),s._v(" 4.配置PHP不缓存")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ .*/.(php|php5)?$ {        \n\tadd_header Cache-Control no-cache;    \n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_5-禁止特定用户代理-user-agents-访问"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-禁止特定用户代理-user-agents-访问"}},[s._v("#")]),s._v(" 5.禁止特定用户代理（User Agents）访问")]),s._v(" "),e("p",[s._v("禁止某些工具，或者搜索引擎蜘蛛爬取")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('if ($http_user_agent ~* (wget|curl|Firefox) ) {\n\treturn 404;\n}\n\n禁止神马搜索\nif ($http_user_agent ~* "YisouSpider") {\n\treturn 403;\n}\n禁止useragent为空\nif ($http_user_agent ~ ^$){\n\treturn 403;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("h3",{attrs:{id:"_6-忽略favicon-ico文件的错误日志"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-忽略favicon-ico文件的错误日志"}},[s._v("#")]),s._v(" 6.忽略favicon.ico文件的错误日志")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location = /favicon.ico {\n    log_not_found off;\n    access_log /dev/null;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_7-禁止某些目录php解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-禁止某些目录php解析"}},[s._v("#")]),s._v(" 7.禁止某些目录php解析")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ .*(diy|template|attachments|forumdata|attachment|image)/.*\\.php$ {\n        deny all;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_8-日志不记录head方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-日志不记录head方法"}},[s._v("#")]),s._v(" 8.日志不记录HEAD方法")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#日志不记录HEAD方法\nif ($request_method = HEAD) {\n    access_log off;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_9-nginx密码认证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-nginx密码认证"}},[s._v("#")]),s._v(" 9.nginx密码认证")]),s._v(" "),e("p",[s._v("HTTP Basic Authentication协议验证的页面")]),s._v(" "),e("p",[s._v("新建密码文件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# yum -y install httpd-tools\n# printf "admin:$(openssl passwd -crypt 123456)\\n" >>/data/conf/sites-available/htpasswd\n# cat /data/conf/sites-available/htpasswd\nadmin:X2dW2ryA9hA7M\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("配置密码：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('location /php {\n                #密码认证\n                auth_basic "nginx basic auth";\n                auth_basic_user_file /data/conf/sites-available/htpasswd;\n                autoindex on;\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("浏览器访问：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20220624114045776.png?aliyun",alt:"image-20220624114045776"}})]),s._v(" "),e("p",[s._v("输入 admin 和123456即可进入。")]),s._v(" "),e("p",[s._v("对于这种有HTTP Basic Authentication协议验证的页面，如果使用curl抓取的话，可以加上账号密码进行请求：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("curl请求：\n# curl -u username:password URL\n例如：  curl -u admin:123456 http://www.nginx01.com/php\n如果用wget下载,可以用：\n# wget --http-user= --http-passwd=passwd URL\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"_10-nginx屏蔽ip方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-nginx屏蔽ip方法"}},[s._v("#")]),s._v(" 10.nginx屏蔽ip方法")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("deny 219.133.188.183; \ndeny 10.0.1.0/24;\n#屏蔽单个IP的命令是\ndeny 123.45.6.7\n#封整个段即从123.0.0.1到123.255.255.254的命令\ndeny 123.0.0.0/8\n#封IP段即从123.45.0.1到123.45.255.254的命令\ndeny 124.45.0.0/16\n#封IP段即从 123.45.6.1到123.45.6.254的命令是\ndeny 123.45.6.0/24\nallow 1.1.1.1; \nallow 1.1.1.2;\ndeny all; \nlocation / {\n    allow 1.1.1.2;\n    deny all;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"_11-阿里云slb场景使用nginx封用户真实ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-阿里云slb场景使用nginx封用户真实ip"}},[s._v("#")]),s._v(" 11.阿里云SLB场景使用NGINX封用户真实IP")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('set $allow true;\nif ($http_x_forwarded_for ~ "106.121.*.*|106.121.71.120|106.121.77.28|106.121.74.130|218.109.235.254"){\n\tset $allow false;\n}\nif ($allow = false){\n\treturn 404;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"_12-禁止代理ip访问-http-x-forwarded-for"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_12-禁止代理ip访问-http-x-forwarded-for"}},[s._v("#")]),s._v(" 12.禁止代理IP访问（http_x_forwarded_for）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ($http_x_forwarded_for ~ (^192\\.168\\.1\\.2$)){\n         return 403;       \n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_13-禁止ip段-192-168-3-142-192-168-3-147"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-禁止ip段-192-168-3-142-192-168-3-147"}},[s._v("#")]),s._v(" 13.禁止IP段：192.168.3.142~192.168.3.147")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ($http_x_forwarded_for ~ (^192\\.168\\.3\\.14[2-7]$)){\n                return 403;\n}\n\nif ($http_x_forwarded_for ~ (^183\\.61\\.51\\.[51-70])){\n                return 403;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"_14-禁止ip段-192-168-64-0-192-168-95-255"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_14-禁止ip段-192-168-64-0-192-168-95-255"}},[s._v("#")]),s._v(" 14.禁止IP段： 192.168.64.0~192.168.95.255")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ($http_x_forwarded_for ~ (^192\\.168\\.[7-8][0-9]\\.\\d+$|^192\\.168\\.[6][4-9]\\.\\d+$|^192\\.168\\.[9][0-5]\\.\\d+$)){\n                return 403;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_15-禁止多个ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_15-禁止多个ip"}},[s._v("#")]),s._v(" 15.禁止多个ip")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('if ($http_x_forwarded_for ~ "223.128.4.250|91.200.12.93") {\n     return 403;     \n  }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_16-禁止ip段-192-168-3-0-254"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_16-禁止ip段-192-168-3-0-254"}},[s._v("#")]),s._v(" 16.禁止IP段：192.168.3.0~254")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ($http_x_forwarded_for ~ (^192\\.168\\.3\\.[0-254]$)){\n\treturn 403;\n}  \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_17-nginx允许跨域"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_17-nginx允许跨域"}},[s._v("#")]),s._v(" 17.nginx允许跨域")]),s._v(" "),e("p",[s._v("当出现403跨域错误的时候 No 'Access-Control-Allow-Origin' header is present on the requested resource，需要给Nginx服务器配置响应的header参数：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("  add_header Access-Control-Allow-Origin *;\n  add_header Access-Control-Allow-Headers X-Requested-With;\n  add_header Access-Control-Allow-Methods GET,POST,OPTIONS;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("服务器默认是不被允许跨域的。给Nginx服务器配置"),e("code",[s._v("Access-Control-Allow-Origin *")]),s._v("后，表示服务器可以接受所有的请求源（Origin）,即接受所有跨域的请求。")]),s._v(" "),e("p",[s._v("Access-Control-Allow-Headers 是为了防止出现以下错误：\nRequest header field Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.")]),s._v(" "),e("p",[s._v('这个错误表示当前请求Content-Type的值不被支持。其实是我们发起了"application/json"的类型请求导致的。这里涉及到一个概念：预检请求（preflight request）,请看下面"预检请求"的介绍。')]),s._v(" "),e("p",[s._v("Access-Control-Allow-Methods 是为了防止出现以下错误：\nContent-Type is not allowed by Access-Control-Allow-Headers in preflight response.")]),s._v(" "),e("p",[s._v('给OPTIONS 添加 204的返回，是为了处理在发送POST请求时Nginx依然拒绝访问的错误\n发送"预检请求"时，需要用到方法 OPTIONS ,所以服务器需要允许该方法。')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location / {  \n    add_header Access-Control-Allow-Origin *;\n    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';\n    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';\n\n    if ($request_method = 'OPTIONS') {\n        return 204;\n    }\n} \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"_18-nginx日志记录post参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_18-nginx日志记录post参数"}},[s._v("#")]),s._v(" 18.nginx日志记录post参数")]),s._v(" "),e("p",[s._v("其实我们只需要把 $request_body 参数加入自定义日志记录信息中即可。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("log_format  main_aliyun_post  '$request_time - RealIP:$clientRealIp - [$time_local] $request - $status - $http_user_agent - $host - from:$http_referer - Request_Body:$request_body';\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"_19-根据域名设置root"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_19-根据域名设置root"}},[s._v("#")]),s._v(" 19.根据域名设置root")]),s._v(" "),e("p",[s._v("需求：多个域名使用相同的配置，需要指定到不同root目录")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("www.a.com\nwww.b.com\n\nroot /data/wwwroot/web/$host/; \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("解释："),e("code",[s._v("/data/wwwroot/web/www.a.com/")]),s._v(" 和 "),e("code",[s._v("/data/wwwroot/web/www.a.com/")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('set $host_pwd "www.a.com";\nif ( $host = \'www.b.com\' ) {\n\tset $host_pwd "www.b.com";\n}\nif ( $host = \'www.c.com\' ) {\n\tset $host_pwd "www.c.com";\n}\nroot /data/wwwroot/web/$host_pwd/;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"_20-判断二级域名"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_20-判断二级域名"}},[s._v("#")]),s._v(" 20.判断二级域名")]),s._v(" "),e("p",[s._v("判断二级域名指定到不同的root目录")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ( $host ~* (\\b(?!www\\b)\\w+)\\.\\w+\\.\\w+ ) {\n\tset $subdomain $1;\n}\nroot /data/wwwroot/html/$subdomain/;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n        listen       80 default;\n        server_name _;\n        access_log /data/wwwroot/log/ios-check-access.log main_aliyun;\n        error_log /dev/null;\n        \n        location / {\n                root /data/wwwroot/html/$host/;\n                index index.html;\n                expires max;\n        }\n     }\nsystemctl reload nginx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"_21-nginx配置x-forwarded-for-防止伪造ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_21-nginx配置x-forwarded-for-防止伪造ip"}},[s._v("#")]),s._v(" 21.nginx配置X-Forwarded-For 防止伪造ip")]),s._v(" "),e("p",[s._v("网上常见nginx配置ip请求头")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("风险： 用户可以通过自己设置请求头来伪造ip，比如用户在发起http请求是自己测试请求头\nx-forwarded-for:192.168.0.151。那么服务器通过x-forwarded-for获取到的第一个ip就是用户伪造的ip。")]),s._v(" "),e("p",[s._v("防止伪造方案：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("情况1: 在只有1层nginx代理的情况下，设置nginx配置“proxy_set_header X-Forwarded-For $remote_addr;”。（此时$remote_addr获取的是用户的真是ip）\n情况2：在有多层反向代理的情况下，\n1）设置“最外层”nginx配置和情况1一样“proxy_set_header X-Forwarded-For $remote_addr;”。\n2）除了“最外层”之外的nginx配置“proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;”。\n　　这样就防止了用户通过伪造请求头来伪造真实ip。后台只需要从x-forwarded-for请求头中取出第一个ip就是用户的真实ip。后面如果有多个ip，就是反向代理的ip\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("其他基础配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ^~ /apk/ {\n                access_log /data/wwwroot/log/www.test.com-access.log;\n                alias /data/wwwroot/web/apk/;\n                expires max;\n        }\t\n\nlocation ~ /(resource|mediatorModule)/ {\n                root    /opt/demo;\n                expires max; 或者\n    \t\t   expires off;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h1",{attrs:{id:"三、nginx-if-判断多条件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、nginx-if-判断多条件"}},[s._v("#")]),s._v(" 三、nginx if 判断多条件")]),s._v(" "),e("p",[s._v("if指令该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("语法")]),s._v(" "),e("th",[s._v("if (condition){...}")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("默认值")]),s._v(" "),e("td",[s._v("—")])]),s._v(" "),e("tr",[e("td",[s._v("位置")]),s._v(" "),e("td",[s._v("server、location")])])])]),s._v(" "),e("h3",{attrs:{id:"_1-变量名"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-变量名"}},[s._v("#")]),s._v(" 1.变量名")]),s._v(" "),e("p",[s._v('如果变量名对应的值为空字符串或"0"，if都判断为false，其他条件为true。')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ($param){\n\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_2-使用-和-比较变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用-和-比较变量"}},[s._v("#")]),s._v(' 2.使用"="和"!="比较变量')]),s._v(" "),e("p",[s._v('使用"="和"!="比较变量和字符串是否相等，满足条件为true，不满足为false')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("如果请求的方法等于POST则返回 405。\nif ($request_method = POST){\n\treturn 405;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_3-使用正则表达式对变量进行匹配"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用正则表达式对变量进行匹配"}},[s._v("#")]),s._v(" 3.使用正则表达式对变量进行匹配，")]),s._v(" "),e("p",[s._v('匹配成功返回true，否则返回false。变量与正则表达式之间使用"~","~'),e("em",[s._v('","!~","!~')]),s._v('"来连接。')]),s._v(" "),e("p",[s._v('"~"代表匹配正则表达式过程中区分大小写，"~*"代表匹配正则表达式过程中不区分大小写')]),s._v(" "),e("p",[s._v('"!~"和"!~*"刚好和上面取相反值，如果匹配上返回false,匹配不上返回true')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("如果http_user_agent中包含MSIE则返回404\nif ($http_user_agent ~ MSIE){\n\t#$http_user_agent的值中是否包含MSIE字符串，如果包含返回true\n\treturn 404;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v('注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含"}"或者是";"等字符时，就需要把引号加上。')]),s._v(" "),e("h3",{attrs:{id:"_4-判断请求的文件是否存在使用-f-和-f"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-判断请求的文件是否存在使用-f-和-f"}},[s._v("#")]),s._v(' 4. 判断请求的文件是否存在使用"-f"和"!-f"')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if (-f $request_filename){\n\t#判断请求的文件是否存在\n}\nif (!-f $request_filename){\n\t#判断请求的文件是否不存在\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[e("p",[s._v('判断请求的目录是否存在使用"-d"和"!-d"')])]),s._v(" "),e("li",[e("p",[s._v('判断请求的目录或者文件是否存在使用"-e"和"!-e"')])]),s._v(" "),e("li",[e("p",[s._v('判断请求的文件是否可执行使用"-x"和"!-x"')])])]),s._v(" "),e("p",[s._v("获取地址中的某个参数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('if ($query_string ~ ".*(?:^|\\?|&)key=(.+?)(?:(?:&.*)|$)") {\n       set $key "$1";\n }\nif ( $uid != $key ){\n       return 301 "https://smartgate.baoan.gov.cn/kshfwpt/H5app/index.html?key=${uid}";\n}\n地址比如是：\nhttps://smartgate.baoan.gov.cn/kshfwpt/H5app/index.html?key=123&method=256\n则$key的值为123\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"nginx-if配合set做判断"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-if配合set做判断"}},[s._v("#")]),s._v(" nginx if配合set做判断")]),s._v(" "),e("p",[s._v("在nginx配置文件中，可以使用if语句，但是对于else语句其实是不支持的，并且and条件和or条件也是不支持的")]),s._v(" "),e("p",[s._v("判断http_x_forwarded_for是否为空，如果为空则正常，如果不为空，则wordpress后台跳转。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("set $my_var '2';\n\nif ( $http_x_forwarded_for ~ ^$){\n    set $my_var 1;\n}\nif ( $my_var = 1) {\n   #如果http_x_forwarded_for为空\n   #rewrite ^/(.*)$ http://127.0.0.1/?11ab21s redirect;\n}\nif ( $my_var = 2) {\n    rewrite ^/wp-login.php(.*) http://127.0.0.1/?s1 redirect;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("h2",{attrs:{id:"nginx设置跳转rewrite"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx设置跳转rewrite"}},[s._v("#")]),s._v(" nginx设置跳转rewrite")]),s._v(" "),e("p",[e("strong",[s._v("$1 $2 $3分别代表前面第一/二/三个()里的内容")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("http://www.nginx01.com/gm001 会跳转到  https://www.baidu.com/game?appid=001\n\nserver {\n  listen       80;\n  server_name  www.nginx01.com;\n  \n  rewrite ^/gm(.*)  https://www.baidu.com/game?appid=$1 redirect;\n}\n\n\n其他：\nrewrite ^/game-tg/rxzg-g(.*)$ http://tg.test.com/game-tg/txhc-g$1 redirect;\nrewrite ^/game-tg/yg/gtjt-g(.*)/(.*)$ http://tg.test.com/game-tg/dhd-g6/$2 redirect;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"匹配链接参数跳转"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#匹配链接参数跳转"}},[s._v("#")]),s._v(" 匹配链接参数跳转")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ( $query_string ~* ^from=dxw_a4$ ){\n        rewrite ^/cps/game/gid/66  http://www.test.com/html/game-tg/gcld-g13/;\n}\n\nhttp://www.nginx01.com/cps/game/gid/66?from=dxw_a4\n会跳转到：\nhttp://www.test.com/html/game-tg/gcld-g13/?from=dxw_a4\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"屏蔽参数带gid-90的链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#屏蔽参数带gid-90的链接"}},[s._v("#")]),s._v(" 屏蔽参数带gid=90的链接")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if ( $query_string ~* (.*)gid=90(.*) ){\n\treturn 403;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("aaa.com/*.html的链接全部重定向到aaa.com/aaa/index.html;")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('rewrite "^/(.*)\\.html$" /aaa/$1.html break;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("/123456/xxxx 跳转 /xxxx?id=123456")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("rewrite ^/(/d+)/(.+)/ /$2?id=$1 last;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"rewrite指令-break-last-redirect-permanent"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rewrite指令-break-last-redirect-permanent"}},[s._v("#")]),s._v(" rewrite指令(break,last,redirect,permanent)")]),s._v(" "),e("p",[s._v("不写last和break - 那么流程就是依次执行这些rewrite")]),s._v(" "),e("h3",{attrs:{id:"_1-rewrite-break"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-rewrite-break"}},[s._v("#")]),s._v(" 1.rewrite break")]),s._v(" "),e("p",[s._v("url重写后，直接使用当前资源，不再执行location里余下的语句，完成本次请求，地址栏url不变")]),s._v(" "),e("p",[s._v("break 终止匹配, 不再匹配后面的规则")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if (!-e $request_filename) {\n\trewrite ^(.*)$ /index.php?s=$1 last;\n\tbreak;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_2-rewrite-last"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-rewrite-last"}},[s._v("#")]),s._v(" 2.rewrite last")]),s._v(" "),e("p",[s._v("url重写后，马上发起一个新的请求，再次进入server块，重试location匹配，超过10次匹配不到报500错误，地址栏url不变")]),s._v(" "),e("p",[s._v("last 相当于Apache里的[L]标记，表示完成rewrite")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('rewrite "/category/(.*).html$" /category/?cd=$1 last;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"_3-rewrite-redirect"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-rewrite-redirect"}},[s._v("#")]),s._v(" 3.rewrite redirect")]),s._v(" "),e("p",[s._v("返回302临时重定向，地址栏显示重定向后的url，爬虫不会更新url（因为是临时）")]),s._v(" "),e("h3",{attrs:{id:"_4-rewrite-permanent"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-rewrite-permanent"}},[s._v("#")]),s._v(" 4.rewrite permanent")]),s._v(" "),e("p",[s._v("返回301永久重定向, 地址栏显示重定向后的url，爬虫更新url")]),s._v(" "),e("h1",{attrs:{id:"四、location中使用root和alias"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、location中使用root和alias"}},[s._v("#")]),s._v(" 四、location中使用root和alias")]),s._v(" "),e("p",[s._v("区别")]),s._v(" "),e("h3",{attrs:{id:"_1-alias指令只能在location块中使用-而root指令则不然"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-alias指令只能在location块中使用-而root指令则不然"}},[s._v("#")]),s._v(" 1.alias指令只能在location块中使用，而root指令则不然")]),s._v(" "),e("h3",{attrs:{id:"_2-root指令会将location块的-url路径-带入到-root指令路径-中-将带入后的路径作为-最终路径-使用-最终路径-与url建立对应关系-alias指令则直接将location块的-url路径-与-alias指令路径-建立对应关系。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-root指令会将location块的-url路径-带入到-root指令路径-中-将带入后的路径作为-最终路径-使用-最终路径-与url建立对应关系-alias指令则直接将location块的-url路径-与-alias指令路径-建立对应关系。"}},[s._v("#")]),s._v(" 2.root指令会将location块的”url路径”带入到”root指令路径”中，将带入后的路径作为”最终路径”，使用”最终路径”与url建立对应关系，alias指令则直接将location块的”url路径”与”alias指令路径”建立对应关系。")]),s._v(" "),e("h2",{attrs:{id:"root示例1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#root示例1"}},[s._v("#")]),s._v(" root示例1")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location /demo {\n    root /opt/test;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("location块匹配的url为”/demo”，root指令的路径为”/opt/test”，那么，根据上述配置，当我们访问”/demo”这个url时，实际上访问的到底是服务器中的哪个路径呢？答案是”/opt/test/demo”路径")]),s._v(" "),e("p",[s._v("实验一下")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mkdir -p /opt/test/demo\necho 'test' > /opt/test/index.html\necho 'demo' >/opt/test/demo/index.html\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("访问")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20220624140721523.png?aliyun",alt:"image-20220624140721523"}})]),s._v(" "),e("p",[s._v("访问 /demo/ 实际是在访问 ‘/opt/test/demo/’。")]),s._v(" "),e("h2",{attrs:{id:"alias示例2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#alias示例2"}},[s._v("#")]),s._v(" alias示例2")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location /demo1 {\n    alias /opt/test;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("访问")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20220624140949024.png?aliyun",alt:"image-20220624140949024"}})]),s._v(" "),e("p",[s._v("访问 /demo1/ 实际是在访问 ‘/opt/test/’。 location的url是与alias的路径完全对等的。")])])}),[],!1,null,null,null);a.default=n.exports}}]);