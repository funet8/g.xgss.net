(window.webpackJsonp=window.webpackJsonp||[]).push([[197],{779:function(s,a,n){"use strict";n.r(a);var t=n(17),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"阿里巴巴开源datax全量同步多个mysql数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#阿里巴巴开源datax全量同步多个mysql数据库"}},[s._v("#")]),s._v(" 阿里巴巴开源DataX全量同步多个MySQL数据库")]),s._v(" "),n("h1",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("上次 写了"),n("a",{attrs:{href:"https://mp.weixin.qq.com/s/_ZXqA3H__Kwk-9O-9dKyOQ",target:"_blank",rel:"noopener noreferrer"}},[s._v("阿里巴巴高效的离线数据同步工具DataX"),n("OutboundLink")],1),s._v("： https://mp.weixin.qq.com/s/_ZXqA3H__Kwk-9O-9dKyOQ 安装DataX这个开源工具，并且同步备份了几张数据表。但是发现一个问题，就是每张表都需要单独写一个 job。如果数据表有几百张是不是要写几百个，这个不太现实了。")]),s._v(" "),n("p",[s._v("正当一筹莫展之际看到看到 @慌途L  https://blog.csdn.net/qq_25112523/article/details/109276879 的文章，我根据文章这篇文章优化了一下，先理一下思路。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://imgoss.xgss.net/picgo/e3606d85c0629ba2dcd0e67c906dfec0edc5faba.jpg?aliyun",alt:"img"}})]),s._v(" "),n("h1",{attrs:{id:"思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[s._v("#")]),s._v(" 思路")]),s._v(" "),n("p",[s._v("实现的目标如图，要将源数据库的所有数据全量同步到目标数据库中。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20230321171446281.png?aliyun",alt:"image-20230321171446281"}})]),s._v(" "),n("h2",{attrs:{id:"三个步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三个步骤"}},[s._v("#")]),s._v(" 三个步骤")]),s._v(" "),n("p",[s._v("1.源库的数据库结构导入到目标库中")]),s._v(" "),n("p",[s._v("2.读取目标库中的所有表名")]),s._v(" "),n("p",[s._v("3.通过DataX执行脚本同步所有数据表。")]),s._v(" "),n("h1",{attrs:{id:"操作流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#操作流程"}},[s._v("#")]),s._v(" 操作流程")]),s._v(" "),n("h2",{attrs:{id:"_1-源库的数据库结构导入到目标库中"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-源库的数据库结构导入到目标库中"}},[s._v("#")]),s._v(" 1.源库的数据库结构导入到目标库中")]),s._v(" "),n("p",[s._v("利用shell脚本读取数据库，导出表结构")]),s._v(" "),n("p",[s._v("https://gitee.com/funet8/MYSQL/raw/master/DataX/Mysql_Init.sh")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /data/datax/script/Mysql_Init.sh \n填写以下内容，全量备份执行一次即可\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#!/bin/bash\n. /etc/profile\n\n# 读库的变量\nr_ip="192.168.1.6"\nr_port="3306"\nr_username="root"\nr_password="123456"\n\n# 写入库的变量\nw_ip="192.168.1.4"\nw_port="61920"\nw_username="star"\nw_password="123456"\n\n# 获取库名\nMysql_Names=`mysql -h$r_ip -u$r_username -p$r_password -P$r_port -e "show databases\\G" |grep \'Database\'|awk -F\'Database: \' \'{print $2}\' |grep -v \'information_schema\\|performance_schema\\|test\\|sys\\|mysql\\|test1|\'`\n\nfunction Mysql_Init(){\n\tmysql_path="/data/datax/mysql/"\n\tmkdir $mysql_path\n\tfor DataBase in $Mysql_Names;\n\t\tdo\n\t\t#1.导出数据库结构：\n\t\tmysqldump -d ${DataBase} -h$r_ip -u$r_username -p$r_password -P$r_port > ${mysql_path}${DataBase}.sql\n\t\t#2.创建数据库\n\t\tmysql -h$w_ip -u$w_username -p$r_password -P$w_port -e "CREATE database ${DataBase} CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"\n\t\t#3.导入数据库结构：\n\t\tmysql -u$w_username -h$w_ip -P$w_port -p$w_password ${DataBase} < ${mysql_path}${DataBase}.sql\n\tdone\n}\n#数据库初始化导出、导入数据库\nMysql_Init\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("h2",{attrs:{id:"_2-读取目标库中的所有库名、表名循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-读取目标库中的所有库名、表名循环"}},[s._v("#")]),s._v(" 2.读取目标库中的所有库名、表名循环")]),s._v(" "),n("p",[s._v("https://gitee.com/funet8/MYSQL/raw/master/DataX/all_Sync_Task.sh")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# vi /data/datax/script/all_Sync_Task.sh \n填写以下内容\n#!/bin/bash\n. /etc/profile\n\n# 读库的变量\nr_ip="192.168.1.6"\nr_port="3306"\nr_username="root"\nr_password="123456"\n\n# 写入库的变量\nw_ip="192.168.1.4"\nw_port="61920"\nw_username="star"\nw_password="123456"\n\nTool_Datax=\'/usr/bin/python2.7 /data/datax/bin/datax.py\'\n\n# 获取库名\nMysql_Names=`mysql -h$r_ip -u$r_username -p$r_password -P$r_port -e "show databases\\G" |grep \'Database\'|awk -F\'Database: \' \'{print $2}\' |grep -v \'information_schema\\|performance_schema\\|test\\|sys\\|mysql\\|test1|\'`\n\nfor dbname in $Mysql_Names;\n\tdo\n\t\t# 获取表名\n\t\ttable_tchema=`mysql -h$r_ip -u$r_username -p$r_password -P$r_port -e "use ${dbname}; show full tables;"|grep \'TABLE\'|awk \'{print $1}\'`\n\t\t#echo $table_tchema;\n\t\t\n\t\t#循环导入数据库\n\t\tfor table_name in $table_tchema;\n\t\t\tdo\n\t\t\t\techo $table_name;\n\t\t\t\t$Tool_Datax  /data/datax/job/mysql2mysql_All.json -p "-Dr_ip=$r_ip -Dr_port=$r_port -Dr_dbname=$dbname -Dr_username=$r_username -Dr_password=$r_password -Dw_ip=$w_ip -Dw_port=$w_port -Dw_dbname=$dbname -Dw_username=$w_username -Dw_password=$w_password -Dtable_name=$table_name"\n\t\tdone\ndone\n\n\n#DataX全量同步(某一张表)\n#$Tool_Python  /data/datax/job/mysql2mysql_dzzoffice.json -p "-Dr_ip=$r_ip -Dr_port=$r_port -Dr_dbname=$r_dbname -Dr_username=$r_username -Dr_password=$r_password -Dw_ip=$w_ip -Dw_port=$w_port -Dw_dbname=$w_dbname -Dw_username=$w_username -Dw_password=$w_password"\n\n# DataX全量同步(多个文件直接写多个执行命令)\n#$Tool_Python  /data/datax/job/mysql2mysql_All.json -p "-Dr_ip=$r_ip -Dr_port=$r_port -Dr_dbname=$r_dbname -Dr_username=$r_username -Dr_password=$r_password -Dw_ip=$w_ip -Dw_port=$w_port -Dw_dbname=$w_dbname -Dw_username=$w_username -Dw_password=$w_password -Dtable_name=$table_name"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br")])]),n("p",[s._v("撰写job脚本")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# vim /data/datax/job/mysql2mysql_All.json\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("https://gitee.com/funet8/MYSQL/raw/master/DataX/mysql2mysql_All.json")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n    "job": {\n\t\t"setting": {\n            "speed": {\n                "channel": 10\n            },\n\t\t\t"errorLimit": {\n                "record": 0,\n                "percentage": 0.02\n            }\n        },\n        "content": [\n            {\n                "reader": {\n                    "name": "mysqlreader", \n                    "parameter": {\n\t\t\t\t\t\t"column": ["*"],\n                        "connection": [\n                            {\n                                "jdbcUrl": ["jdbc:mysql://${r_ip}:${r_port}/${r_dbname}?serverTimezone=Asia/Shanghai&characterEncoding=utf8&useSSL=false&zeroDateTimeBehavior=convertToNull"],\n                                "table": ["${table_name}"]\n                            }\n                        ], \n\t\t\t\t\t\t"username": "${r_username}",\n                        "password": "${r_password}"\n                    }\n                }, \n                "writer": {\n                    "name": "mysqlwriter", \n                    "parameter": {\n\t\t\t\t\t\t"writeMode": "update",\n                        "column": ["*"],\n                        "session": [\n                        \t"set session sql_mode=\'ANSI\'"\n                        ],\n                        "connection": [\n                            {\n                                "jdbcUrl": "jdbc:mysql://${w_ip}:${w_port}/${w_dbname}?serverTimezone=Asia/Shanghai&characterEncoding=utf8&useSSL=false&zeroDateTimeBehavior=convertToNull", \n                                "table": ["${table_name}"]\n                            }\n                        ],\n\t\t\t\t\t\t"username": "${w_username}",\n                        "password": "${w_password}"\n                    }\n                }\n            }\n        ]\n    }\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br")])]),n("h2",{attrs:{id:"_3-通过datax执行脚本同步所有数据表。"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-通过datax执行脚本同步所有数据表。"}},[s._v("#")]),s._v(" 3.通过DataX执行脚本同步所有数据表。")]),s._v(" "),n("p",[s._v("执行脚本")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# sh /data/datax/script/all_Sync_Task.sh \n会输出信息\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20230321173659358.png?aliyun",alt:"image-20230321173659358"}})]),s._v(" "),n("p",[s._v("说明同步成功，如果有报错，根据报错解决BUG即可。")]),s._v(" "),n("h1",{attrs:{id:"结果展示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#结果展示"}},[s._v("#")]),s._v(" 结果展示")]),s._v(" "),n("h2",{attrs:{id:"源数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#源数据库"}},[s._v("#")]),s._v(" 源数据库")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20230320102328525.png?aliyun",alt:"image-20230320102328525"}})]),s._v(" "),n("h2",{attrs:{id:"同步之前"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同步之前"}},[s._v("#")]),s._v(" 同步之前")]),s._v(" "),n("p",[n("img",{attrs:{src:"H:/typora_images/image-20230320102231494.png",alt:"image-20230320102231494"}})]),s._v(" "),n("h2",{attrs:{id:"同步之后"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同步之后"}},[s._v("#")]),s._v(" 同步之后")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://imgoss.xgss.net/picgo/image-20230320103457137.png?aliyun",alt:"image-20230320103457137"}})]),s._v(" "),n("p",[s._v("至此全量同步完成。")]),s._v(" "),n("p",[s._v("参考： https://blog.csdn.net/qq_25112523/article/details/109276879")])])}),[],!1,null,null,null);a.default=e.exports}}]);