(window.webpackJsonp=window.webpackJsonp||[]).push([[168],{748:function(s,n,t){"use strict";t.r(n);var a=t(17),e=Object(a.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"linux安装rsync和inotify实现文件夹实时同步"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux安装rsync和inotify实现文件夹实时同步"}},[s._v("#")]),s._v(" Linux安装rsync和inotify实现文件夹实时同步")]),s._v(" "),t("h2",{attrs:{id:"需求说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求说明"}},[s._v("#")]),s._v(" 需求说明")]),s._v(" "),t("p",[s._v("在web服务器中，作为代码发布机A，文件同步到服务器B,C,D等集群中，可以忽略某个文件和目录。")]),s._v(" "),t("p",[s._v("A服务器：内网IP: 192.168.1.2")]),s._v(" "),t("p",[s._v("B服务器：内网IP： 192.168.1.3")]),s._v(" "),t("p",[s._v("A和B的www用户，或者root用户免密登录。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://imgoss.xgss.net/picgo/rsyncheinotify.jpg?aliyun",alt:"rsyncheinotify"}})]),s._v(" "),t("h2",{attrs:{id:"rsync介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rsync介绍"}},[s._v("#")]),s._v(" rsync介绍")]),s._v(" "),t("p",[s._v("rsync是linux系统下的数据镜像备份工具。使用快速增量备份工具Remote Sync可以远程同步，支持本地复制，或者与其他SSH、rsync主机同步。")]),s._v(" "),t("h2",{attrs:{id:"inotify介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inotify介绍"}},[s._v("#")]),s._v(" inotify介绍")]),s._v(" "),t("p",[s._v("inotify是一种强大的、细粒度的、异步的文件系统事件监控机制，linux内核从2.6.13起，加入了inotify支持，通过inotify可以监控文件系统中添加、删除，修改、移动等各种细微事件，利用这个内核接口，第三方软件就可以监控文件系统下文件的各种变化情况，而inotify-tools就是这样的一个第三方软件。")]),s._v(" "),t("h2",{attrs:{id:"_1-安装rsync"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装rsync"}},[s._v("#")]),s._v(" 1.安装rsync")]),s._v(" "),t("p",[s._v("A和B都做")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("yum -y install xinetd\nyum -y install rsync\n\nchkconfig  rsync  on\n\nservice xinetd restart\nsystemctl restart xinetd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("A上操作：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("rsync -av root@192.168.1.3:/rsynctest/1.txt /root\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("B上操作")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('rsync -av /rsynctest/2.txt root@192.168.1.2:/root\nrsync -av -e "ssh -p 22" /rsynctest/2.txt root@192.168.1.2:/root \t\t【如果ssh的开启的端口不是22 则用-e指定ssh端口】\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_2-安装-inotify"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装-inotify"}},[s._v("#")]),s._v(" 2.安装 inotify")]),s._v(" "),t("p",[s._v("只在A上操作即可。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("安装inotify-tools\nyum install inotify-tools -y\n\n也可以安装包\nwget http://js.地址funet8地址.com/centos_software/inotify-tools-3.14.tar.gz\ntar -zxvf inotify-tools-3.14.tar.gz \ncd inotify-tools-3.14\n./configure\nmake \nmake install\n\ninotifywait -m /root\t【查看inotify-tools是否运行正常】\n\n\n新开一个终端：\n[root@localhost ~]# cd /root\n[root@localhost ~]# touch bb.txt\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("监控到")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# inotifywait -m /root\nSetting up watches.\nWatches established.\n/root/ OPEN .bash_profile\n/root/ ACCESS .bash_profile\n/root/ CLOSE_NOWRITE,CLOSE .bash_profile\n/root/ OPEN .bashrc\n/root/ ACCESS .bashrc\n/root/ CLOSE_NOWRITE,CLOSE .bashrc\n/root/ CREATE bb.txt\n/root/ OPEN bb.txt\n/root/ ATTRIB bb.txt\n/root/ CLOSE_WRITE,CLOSE bb.txt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h2",{attrs:{id:"网站实时同步脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网站实时同步脚本"}},[s._v("#")]),s._v(" 网站实时同步脚本")]),s._v(" "),t("p",[s._v("test.sh 为要运行网站实时同步脚本\n其中定义了要同步的网站的路径，要同步到的ip地址，哪些后缀名的文件忽略监控，同步的用户名，同步的文件列表，哪些文件不需要同步。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('cat test.sh\n#!/bin/sh\nSRC=/data/wwwroot/web/test/ #代码发布服务器目录\nDST=/data/wwwroot/web/test/ #目标服务器目录\n\nIP="192.168.1.3 192.168.1.4" # 这里可以用hostname，多个主机用空格\nUSER=www\ninotifywait -mrq $SRC -e modify,delete,create,close_write,attrib  | while read D E F  \n        do  \n                for i in $IP\n                do\n                        #排除后缀名和目录\n                        /usr/bin/rsync -e \'ssh -p 60920\' \\\n                        -ahqzt --exclude "*.swp" \\\n                        --exclude "*.svn" \\\n                        --exclude "test/" \\\n                        --exclude "runtime/" \\\n                        --delete $SRC $USER@$i:$DST\n                done\n        done\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("运行：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("增加权限：\nchmod +x test.sh\n\n后台运行：\nnohup ./test.sh > nohup_test 2>&1 &\n\n生成一个文件才能触发文件同步\ntouch /data/wwwroot/web/test/test_rsync_`date +%Y%m%d-%H:%M:%S`.html\n\n删除测试文件\nrm -rf /data/wwwroot/web/test/test_rsync*.html\n\n测试文件是否同步\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);