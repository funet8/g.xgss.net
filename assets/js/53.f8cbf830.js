(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{635:function(s,a,e){"use strict";e.r(a);var t=e(17),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"docker与iptables如何限制暴露的对外访问端口"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker与iptables如何限制暴露的对外访问端口"}},[s._v("#")]),s._v(" docker与iptables如何限制暴露的对外访问端口")]),s._v(" "),e("p",[s._v("docker 会在iptables上加上自己的转发规则，如果直接在input链上限制端口是没有效果的。这就需要限制docker的转发链上的DOCKER表。")]),s._v(" "),e("h2",{attrs:{id:"查询docker表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查询docker表"}},[s._v("#")]),s._v(" 查询docker表")]),s._v(" "),e("p",[s._v("查询DOCKER表并显示规则编号")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -L DOCKER -n --line-number\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"修改iptables规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改iptables规则"}},[s._v("#")]),s._v(" 修改iptables规则")]),s._v(" "),e("p",[s._v("修改对应编号的iptables 规则，这里添加了允许访问ip的限制")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -R DOCKER 5 -p tcp -m tcp -s 192.168.1.0/24 --dport 3000 -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"禁止某个网段访问"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#禁止某个网段访问"}},[s._v("#")]),s._v(" 禁止某个网段访问")]),s._v(" "),e("p",[s._v("在Chain DOCKER 中增加配置，禁止192.168.1.0/24网段的访问可按照如下配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I DOCKER -s 192.168.1.0/24 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("想要阻止容器172.18.0.2，它的端口是7053")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I FORWARD -p tcp -d 172.18.0.2 --dport 7053 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"阻止9200端口访问"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#阻止9200端口访问"}},[s._v("#")]),s._v(" 阻止9200端口访问")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I DOCKER 1 -p tcp --dport 9200 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("只允许192.168.1.1访问docker的服务，其中ext_if是你机器上的实际网卡名")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I DOCKER-USER -i ext_if ! -s 192.168.1.1 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"只允许网段192-168-1-0-24"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#只允许网段192-168-1-0-24"}},[s._v("#")]),s._v(" 只允许网段192.168.1.0/24")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I DOCKER-USER -i ext_if ! -s 192.168.1.0/24 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"只允许ip范围"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#只允许ip范围"}},[s._v("#")]),s._v(" 只允许ip范围")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("iptables -I DOCKER-USER -m iprange -i ext_if ! --src-range 192.168.1.1-192.168.1.3 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Docker加入自定义iptables规则链（新建一个链加在FORWARD中进行处理）\nhttps://www.cnblogs.com/jiftle/p/13821394.html")]),s._v(" "),e("p",[s._v("PS : 这位同学整理了iptables的详细文档，非常详细，推荐阅读。\nhttps://www.kancloud.cn/jiftle/iptables-detailed-introduction/1972252")]),s._v(" "),e("p",[s._v("iptables禁用docker暴露的端口（在nat表的DOCKER链中处理）\nhttps://blog.csdn.net/u010544187/article/details/86698201")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#我的eth1是外网网卡 eth0是内网网卡\n#由于DOCKER-USER链上原本有一条RETURN规则，因此这里使用-I做插入\n \n#提供访问的是外网ip，所以在eth1上做策略，不是白名单的就DROP\niptables -I DOCKER-USER -i eth1 ! -s 白名单ip -j DROP\n \n#eth0对应的内网ip不开放，不允许访问\niptables -I DOCKER-USER -i eth0 -j DROP\n \n#由于外网网卡提供业务，而业务回包也是从外网网卡走的，因此需要增加连接状态，如果是回包的话也允许通过\niptables -I DOCKER-USER -i eth1 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT\n \n \n#这样做的优点是\n#1、符合官方文档，只操作DOCKER-USER链，相对优雅\n#2、不用处理复杂的SNAT或DNAT规则\n#缺点是：\n#1、需要手动识别网卡，或者额外写一段bash识别不同机器的外网网卡。\n#2、需要在iptables、docker启动之后，额外执行以上三句iptables\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);