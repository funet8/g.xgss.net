(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{620:function(s,a,t){"use strict";t.r(a);var e=t(17),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"linux服务器故障排查基本方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux服务器故障排查基本方案"}},[s._v("#")]),s._v(" Linux服务器故障排查基本方案")]),s._v(" "),t("h1",{attrs:{id:"服务器架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务器架构"}},[s._v("#")]),s._v(" 服务器架构")]),s._v(" "),t("p",[s._v("服务器系统为Centos7")]),s._v(" "),t("p",[s._v("首先需要知晓系统的对外的架构")]),s._v(" "),t("p",[s._v("一般架构：")]),s._v(" "),t("p",[s._v("1.域名---\x3e云服务器（ECS）")]),s._v(" "),t("p",[s._v("2.域名---\x3eCDN---\x3e云服务器（OSS）")]),s._v(" "),t("p",[s._v("3.域名---\x3eCDN---\x3e云服务器ECS+数据库RDS+缓存Redis")]),s._v(" "),t("p",[s._v("4.域名---\x3eCDN---\x3e负载均衡---\x3e云服务器ECS+数据库RDS(主从)+缓存Redis")]),s._v(" "),t("p",[s._v("5.域名---\x3eCDN--\x3eWAF防火墙---\x3e负载均衡---\x3e云服务器ECS+数据库RDS(主从)+缓存Redis")]),s._v(" "),t("p",[s._v("再根据实际情况出现的问题，一步步排查。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://imgoss.xgss.net/picgo/Linux-fwuqi-chakanliuchangsss.jpg?aliyun",alt:"Linux-fwuqi-chakanliuchangsss"}})]),s._v(" "),t("h1",{attrs:{id:"发现问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发现问题"}},[s._v("#")]),s._v(" 发现问题")]),s._v(" "),t("h1",{attrs:{id:"一、发现问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、发现问题"}},[s._v("#")]),s._v(" 一、发现问题")]),s._v(" "),t("p",[s._v("首先发现问题，及时确定哪个服务出现问题，以便方便快速定位问题。查找对应的域名和设备")]),s._v(" "),t("h2",{attrs:{id:"zabbix监控发钉钉告警"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#zabbix监控发钉钉告警"}},[s._v("#")]),s._v(" Zabbix监控发钉钉告警")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://imgoss.xgss.net/picgo/1614243525084-f79b25e3-c800-40c4-bb82-6945b2340386.png?aliyun",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"阿里云监控告警短信"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#阿里云监控告警短信"}},[s._v("#")]),s._v(" 阿里云监控告警短信")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("【阿里云】尊敬的***,云监控-云数据库RDS版<华南1(深圳)-*****-只读>于<09:54>发生报警，CPU使用率（91.88>=80），持续时间4分钟\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-shell脚本邮件告警"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-shell脚本邮件告警"}},[s._v("#")]),s._v(" 3.shell脚本邮件告警")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://imgoss.xgss.net/picgo/1614243666883-c830f798-fbbd-413f-bdd4-d26a9333c56f.png?aliyun",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"_4-其他同事"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-其他同事"}},[s._v("#")]),s._v(" 4.其他同事")]),s._v(" "),t("p",[s._v("客服、市场同事等钉钉、电话报告出现的问题")]),s._v(" "),t("h2",{attrs:{id:"二、快速定位问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、快速定位问题"}},[s._v("#")]),s._v(" 二、快速定位问题")]),s._v(" "),t("h3",{attrs:{id:"网络带宽-cdn是否异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络带宽-cdn是否异常"}},[s._v("#")]),s._v(" 网络带宽（CDN是否异常）")]),s._v(" "),t("p",[s._v("域名是否解析到源站")]),s._v(" "),t("p",[s._v("登录阿里云CDN后台查看相应流量")]),s._v(" "),t("h3",{attrs:{id:"负载均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[s._v("#")]),s._v(" 负载均衡")]),s._v(" "),t("p",[s._v("检查负载均衡是否正常运行，是否流量异常")]),s._v(" "),t("h3",{attrs:{id:"应用层服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应用层服务器"}},[s._v("#")]),s._v(" 应用层服务器")]),s._v(" "),t("p",[s._v("ECS服务器负载是否正常、cpu、内存负载是否过高，硬盘使用率是否达到100%等")]),s._v(" "),t("h3",{attrs:{id:"缓存服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#缓存服务器"}},[s._v("#")]),s._v(" 缓存服务器")]),s._v(" "),t("p",[s._v("redis服务器负载是否正常、内存使用率如何")]),s._v(" "),t("h3",{attrs:{id:"数据库服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库服务器"}},[s._v("#")]),s._v(" 数据库服务器")]),s._v(" "),t("p",[s._v("数据库连接数是否正常")]),s._v(" "),t("p",[s._v("列出当前用户的所有连接信息；")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("show full processlist; \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("杀进程，时长消耗太长的sql进程")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("select concat('kill ', id, ';') from information_schema.processlist where command != 'Sleep' and time > 2*60 order by time desc; \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("让将sql语句发给后端研发分析")]),s._v(" "),t("h2",{attrs:{id:"远程连接服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#远程连接服务器"}},[s._v("#")]),s._v(" 远程连接服务器")]),s._v(" "),t("h1",{attrs:{id:"问题-cpu高-负载高-访问慢-数据库正常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-cpu高-负载高-访问慢-数据库正常"}},[s._v("#")]),s._v(" 问题：CPU高，负载高，访问慢（数据库正常）")]),s._v(" "),t("h2",{attrs:{id:"系统层面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统层面"}},[s._v("#")]),s._v(" 系统层面")]),s._v(" "),t("h3",{attrs:{id:"查看负载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看负载"}},[s._v("#")]),s._v(" 查看负载")]),s._v(" "),t("p",[s._v("查看负载、CPU、内存、上线时间、高资源进程")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# top\n安装： yum -y install htop\n# htop \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("查看top服务器负载，内存消耗，df -h查看硬盘")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("top\ndf \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://imgoss.xgss.net/picgo/1614243765194-e9717edb-39a8-410c-88e2-d8f1b3b2906f.png?aliyun",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"查看nginx日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看nginx日志"}},[s._v("#")]),s._v(" 查看nginx日志")]),s._v(" "),t("p",[s._v("如果有nginx日志，进入nginx日志目录")]),s._v(" "),t("p",[s._v("按照日志大小排列")]),s._v(" "),t("p",[s._v("判断日志访问、相应时长，url等")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("cd /data/wwwroot/log\nll -Srh\ntail -f XXX.XXX.COM-access.log\n分析日志，找出最多的IP日志、最多的URL等\nGoAccess 、ELK后台查看日志\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"查看磁盘使用情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看磁盘使用情况"}},[s._v("#")]),s._v(" 查看磁盘使用情况")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("df -h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"查看磁盘当前情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看磁盘当前情况"}},[s._v("#")]),s._v(" 查看磁盘当前情况")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("iostat -x -k 3 3\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           3.70    0.00    2.25    0.41    0.00   93.64\n\nDevice:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util\nvda               0.01     0.83    0.30    1.48    11.34    12.13    26.30     0.01    6.15    7.41    5.89   0.24   0.04\nvdb               0.00     0.17    0.02    0.28     0.08     2.75    19.15     0.00    3.22    2.01    3.29   0.26   0.01\nvdc               0.10     0.84    3.09    0.56   105.22    20.57    68.94     0.02    7.96    3.29   33.74   1.33   0.49\n\n如果发现当前磁盘忙碌，则查看是哪个 PID 在忙碌：\n安装 yum install -y iotop\n# iotop -o -P -k -d 5\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h3",{attrs:{id:"查看对外服务和端口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看对外服务和端口"}},[s._v("#")]),s._v(" 查看对外服务和端口")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# netstat -tunpl\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:62920           0.0.0.0:*               LISTEN      29177/vsftpd        \ntcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      4393/httpd      \ntcp        0      0 0.0.0.0:7300            0.0.0.0:*               LISTEN      4697/php-fpm: maste \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"查看-pid-具体在"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看-pid-具体在"}},[s._v("#")]),s._v(" 查看 PID 具体在")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("安装  yum install lsof\n\nlsof -p PID\nlsof -p 29177\nlsof -p 4697 \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"查看系统日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看系统日志"}},[s._v("#")]),s._v(" 查看系统日志")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("tail -400f /var/log/messages\ntail -f /var/log/messages\ntail -n100 /var/log/messages\nhead -n100 /var/log/messages\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"查看简化线程树"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看简化线程树"}},[s._v("#")]),s._v(" 查看简化线程树")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("pstree -a >> /root/pstree.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"网络问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络问题"}},[s._v("#")]),s._v(" 网络问题")]),s._v(" "),t("h3",{attrs:{id:"ping域名"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ping域名"}},[s._v("#")]),s._v(" ping域名")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ping www.XXX.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"查看网络节点情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看网络节点情况"}},[s._v("#")]),s._v(" 查看网络节点情况")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("安装： yum install -y  traceroute\n\ntraceroute www.baidu.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h1",{attrs:{id:"问题-cpu-低-负载高-访问慢-数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-cpu-低-负载高-访问慢-数据库"}},[s._v("#")]),s._v(" 问题：CPU 低，负载高，访问慢（数据库）")]),s._v(" "),t("h2",{attrs:{id:"判断的数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#判断的数据库"}},[s._v("#")]),s._v(" 判断的数据库")]),s._v(" "),t("h3",{attrs:{id:"_1-慢查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-慢查询"}},[s._v("#")]),s._v(" 1.慢查询")]),s._v(" "),t("p",[s._v("检查慢查询日志，可能是慢查询引起负载高，根据配置文件查看存放位置：log_slow_queries")]),s._v(" "),t("h3",{attrs:{id:"_2-是否有系统瓶颈"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-是否有系统瓶颈"}},[s._v("#")]),s._v(" 2.是否有系统瓶颈")]),s._v(" "),t("p",[s._v("升级系统cpu、内存、硬盘，")]),s._v(" "),t("p",[s._v("优化架构增加主从，一主多从等。")]),s._v(" "),t("h3",{attrs:{id:"_3-sleep连接是否过多"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-sleep连接是否过多"}},[s._v("#")]),s._v(" 3.sleep连接是否过多")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("show full processlist;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-查看最大连接数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-查看最大连接数"}},[s._v("#")]),s._v(" 4.查看最大连接数")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("查看设置的最大连接数\nshow variables like 'max_connections';\n重新设置最大连接数\nset GLOBAL max_connections=300\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h1",{attrs:{id:"nginx防护基本命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx防护基本命令"}},[s._v("#")]),s._v(" Nginx防护基本命令")]),s._v(" "),t("p",[s._v("如果有一些异常访问，可以加入配合阿里云的WAF。")]),s._v(" "),t("h3",{attrs:{id:"访问最多真实用户的ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问最多真实用户的ip"}},[s._v("#")]),s._v(" 访问最多真实用户的IP")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("cat www.XXXX.com-access.log |awk '{print $5}'| awk -F\":\" '{print $NF}' |sort|uniq -c|sort -nr|head -10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"查看访问排行前10的url"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看访问排行前10的url"}},[s._v("#")]),s._v(" 查看访问排行前10的url")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("cat  www.XXX.com-access.log | awk '{print $10}' | sort | uniq -c | sort -nr | head -n 10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"执行时间最长10条"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行时间最长10条"}},[s._v("#")]),s._v(" 执行时间最长10条")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("cat  www.XXX.com-access.log | sort -nr | head -n 10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"查看http-referer来路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看http-referer来路"}},[s._v("#")]),s._v(" 查看http_referer来路：")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("cat www.XXX.com-access.log | awk -F\"from:\" '{print $NF}' |sort|uniq -c|sort -nr|head -10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("封IP，查看特定的referer来源地址")]),s._v(" "),t("h3",{attrs:{id:"服务器防火墙封ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务器防火墙封ip"}},[s._v("#")]),s._v(" 服务器防火墙封ip")]),s._v(" "),t("p",[s._v("封IP段")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("/sbin/iptables -I INPUT -s 61.37.80.0/24 -j DROP\n#屏蔽单个IP的命令是\n deny 123.45.6.7\n #封整个段即从123.0.0.1到123.255.255.254的命令\n deny 123.0.0.0/8\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"禁止特定用户代理-user-agents-访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#禁止特定用户代理-user-agents-访问"}},[s._v("#")]),s._v(" 禁止特定用户代理（User Agents）访问")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("if ($http_user_agent ~* (wget|curl|Firefox) ) {\nreturn 404;\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"特定的地址攻击做跳转"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#特定的地址攻击做跳转"}},[s._v("#")]),s._v(" 特定的地址攻击做跳转")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("rewrite ^/accounts/\\+\\$str\\+ http://127.0.0.1/ redirect;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"根据-user-agent-控制客户端访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#根据-user-agent-控制客户端访问"}},[s._v("#")]),s._v(" 根据 user_agent 控制客户端访问")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("location / {\n       if ($http_user_agent ~ 'bingbot/2.0|MJ12bot/v1.4.2|Spider/3.0|YoudaoBot|Tomato|Gecko/20100315'){\n                return 403;\n                }\n       }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"图片防盗链"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#图片防盗链"}},[s._v("#")]),s._v(" 图片防盗链")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("valid_referers none blocked *.XXX.com server_names ~\\.google\\. ~\\.baidu\\.;\n                if ($invalid_referer) {\n                        # return 403;\n                        rewrite ^/ http://www.XXX.com/daoling.png;\n                }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"不允许host为localhost访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不允许host为localhost访问"}},[s._v("#")]),s._v(" 不允许host为localhost访问")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("if ($host = 'localhost') {\n                return 403;\n       }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"不允许agent为空"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不允许agent为空"}},[s._v("#")]),s._v(" 不允许agent为空")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("if ($http_user_agent ~ ^$){\n                return 403;\n       }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"不允许绑定host主机访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不允许绑定host主机访问"}},[s._v("#")]),s._v(" 不允许绑定host主机访问")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("if ($http_x_forwarded_for ~ ^$){\n                return 402;\n       }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);